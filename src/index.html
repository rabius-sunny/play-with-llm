<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>E-commerce AI Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify for XSS protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <style>
      .markdown-content {
        line-height: 1.6;
      }

      .markdown-content h1,
      .markdown-content h2,
      .markdown-content h3,
      .markdown-content h4,
      .markdown-content h5,
      .markdown-content h6 {
        font-weight: bold;
        margin: 0.5em 0 0.3em 0;
      }

      .markdown-content h1 {
        font-size: 1.5em;
      }
      .markdown-content h2 {
        font-size: 1.3em;
      }
      .markdown-content h3 {
        font-size: 1.1em;
      }

      .markdown-content p {
        margin: 0.5em 0;
      }

      .markdown-content ul,
      .markdown-content ol {
        margin: 0.5em 0;
        padding-left: 1.5em;
      }

      .markdown-content li {
        margin: 0.2em 0;
      }

      .markdown-content strong,
      .markdown-content b {
        font-weight: bold;
      }

      .markdown-content em,
      .markdown-content i {
        font-style: italic;
      }

      .markdown-content code {
        background-color: rgba(0, 0, 0, 0.1);
        padding: 0.1em 0.3em;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
      }

      .markdown-content pre {
        background-color: rgba(0, 0, 0, 0.05);
        padding: 0.8em;
        border-radius: 5px;
        overflow-x: auto;
        margin: 0.5em 0;
      }

      .markdown-content pre code {
        background-color: transparent;
        padding: 0;
      }

      .markdown-content blockquote {
        border-left: 3px solid #ccc;
        margin: 0.5em 0;
        padding-left: 1em;
        color: #666;
      }

      .markdown-content table {
        border-collapse: collapse;
        width: 100%;
        margin: 0.5em 0;
        min-width: 100%;
      }

      .markdown-content .table-wrapper {
        overflow-x: auto;
        margin: 0.5em 0;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .markdown-content th,
      .markdown-content td {
        border: 1px solid #ddd;
        padding: 0.5em 0.8em;
        text-align: left;
        min-width: 120px;
        white-space: nowrap;
      }

      .markdown-content td.wrap-text {
        white-space: normal;
        word-break: break-word;
        max-width: 200px;
      }

      .markdown-content th {
        background-color: rgba(0, 0, 0, 0.05);
        font-weight: bold;
      }

      .markdown-content a {
        color: #3b82f6;
        text-decoration: underline;
      }

      .markdown-content a:hover {
        color: #1d4ed8;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 min-h-screen flex flex-col items-center justify-center"
  >
    <h1 class="text-4xl text-center my-5 font-bold text-blue-600">
      E-commerce AI Assistant
    </h1>
    <p class="text-center text-gray-600 mb-4">
      Ask me about products in any language! Try: "gaming laptop under $1000" or
      "iPhone vs Samsung"
    </p>

    <div
      class="w-full max-w-2xl bg-white rounded-lg shadow-lg p-6 flex flex-col h-[70vh]"
    >
      <div
        id="chat"
        class="flex-1 overflow-auto mb-4 space-y-3 p-2"
      ></div>

      <div
        id="typing-indicator"
        class="hidden text-gray-500 italic mb-2"
      >
        AI is thinking...
      </div>

      <form
        id="chat-form"
        class="flex gap-3"
      >
        <input
          id="user-input"
          type="text"
          class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Ask about products... (e.g., 'gaming laptop under $1000')"
          required
        />
        <button
          type="submit"
          id="send-btn"
          class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors"
        >
          Send
        </button>
      </form>
    </div>

    <!-- Debug info -->
    <div
      id="debug-info"
      class="mt-4 p-3 bg-gray-50 rounded text-xs text-gray-600 max-w-2xl w-full"
    ></div>

    <script>
      const chat = document.getElementById('chat');
      const form = document.getElementById('chat-form');
      const input = document.getElementById('user-input');
      const sendBtn = document.getElementById('send-btn');
      const typingIndicator = document.getElementById('typing-indicator');
      const debugInfo = document.getElementById('debug-info');

      // Configure marked for better rendering
      marked.setOptions({
        breaks: true,
        gfm: true,
        sanitize: false // We'll use DOMPurify instead
      });

      // Generate a simple user ID for session tracking
      const userId = 'user_' + Math.random().toString(36).substr(2, 9);

      function parseMarkdown(text) {
        // Parse markdown
        let html = marked.parse(text);
        // Wrap tables in scrollable containers
        html = html.replace(/<table>/g, '<div class="table-wrapper"><table>');
        html = html.replace(/<\/table>/g, '</table></div>');
        // Sanitize HTML to prevent XSS
        return DOMPurify.sanitize(html);
      }

      function addMessage(text, from, metadata = null) {
        const msg = document.createElement('div');
        msg.className = from === 'user' ? 'text-right' : 'text-left';

        // Process content based on sender
        const content = from === 'bot' ? parseMarkdown(text) : text;
        const isMarkdown = from === 'bot';

        const messageContent = `
          <div class="inline-block ${
            from === 'user' ? 'max-w-[80%]' : 'w-full'
          } px-4 py-3 rounded-lg ${
          from === 'user'
            ? 'bg-blue-500 text-white'
            : 'bg-gray-200 text-gray-800'
        }">
            <div class="${
              isMarkdown ? 'markdown-content' : 'whitespace-pre-wrap'
            }">${content}</div>
            ${
              metadata
                ? `<div class="text-xs mt-2 opacity-70">
              ${metadata.cached ? 'üìã Cached' : 'üîç Fresh'} | 
              ${metadata.productCount || 0} products found
            </div>`
                : ''
            }
          </div>
        `;

        msg.innerHTML = messageContent;
        chat.appendChild(msg);
        chat.scrollTop = chat.scrollHeight;

        // Update debug info
        if (metadata) {
          debugInfo.innerHTML = `
            <strong>Debug Info:</strong> 
            Products found: ${metadata.productCount}, 
            Cached: ${metadata.cached}, 
            Intent: ${metadata.parsedQuery?.intent || 'unknown'}
          `;
        }
      }

      function setLoading(loading) {
        sendBtn.disabled = loading;
        sendBtn.textContent = loading ? 'Sending...' : 'Send';
        typingIndicator.classList.toggle('hidden', !loading);
      }

      // Add welcome message
      addMessage(
        'Hi! I\'m your e-commerce AI assistant. I can help you find products, compare items, and answer questions about our inventory. Try asking me something like "show me gaming laptops under $1500" or "compare iPhone with Samsung phones".',
        'bot'
      );

      form.onsubmit = async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        addMessage(text, 'user');
        input.value = '';
        setLoading(true);

        try {
          const res = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: text,
              userId: userId
            })
          });

          const data = await res.json();

          if (res.ok) {
            addMessage(data.reply, 'bot', data.metadata);
          } else {
            addMessage(
              `Error: ${data.error || 'Unknown error occurred'}`,
              'bot'
            );
          }
        } catch (error) {
          console.error('Request failed:', error);
          addMessage(
            "Sorry, I'm having trouble connecting. Please try again.",
            'bot'
          );
        } finally {
          setLoading(false);
        }
      };

      // Auto-focus input
      input.focus();
    </script>
  </body>
</html>
